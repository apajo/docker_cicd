#!/bin/bash

export ROOT="$(pwd)"
[ ! -f $ROOT/.env ] || set -o allexport; source $ROOT/.env; set +o allexport;
[ ! -f $ROOT/.env.local ] || set -o allexport; source $ROOT/.env.local; set +o allexport;

NC='\033[0m'     # No color (resets text formatting)

# Regular Colors
BLACK='\033[0;30m'   # Black
RED='\033[0;31m'     # Red
GREEN='\033[0;32m'   # Green
YELLOW='\033[0;33m'  # Yellow
BLUE='\033[0;34m'    # Blue
PURPLE='\033[0;35m'  # Purple
CYAN='\033[0;36m'    # Cyan
WHITE='\033[0;37m'   # White

# Bold
BOLD_BLACK='\033[1;30m'  # Black
BOLD_RED='\033[1;31m'    # Red
BOLD_GREEN='\033[1;32m'  # Green
BOLD_YELLOW='\033[1;33m' # Yellow
BOLD_BLUE='\033[1;34m'   # Blue
BOLD_PURPLE='\033[1;35m' # Purple
BOLD_CYAN='\033[1;36m'   # Cyan
BOLD_WHITE='\033[1;37m'  # White

SSH_CMD="ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null "

echo -e "\n${CYAN}Hosts:${NC}\n"

echo -e "Staging: ${CYAN}$STAGING_USER@$STAGING_HOST:$STAGING_PORT${NC}"
echo -e "Production: ${CYAN}$PRODUCTION_USER@$PRODUCTION_HOST:$PRODUCTION_PORT${NC}"

echo -e "\n${CYAN}Retrieving keys...${NC}\n"

HOST_PUBLIC_KEY=$(cat $HOME/.ssh/id_rsa.pub);
STAGING_PUBLIC_KEY=$($SSH_CMD -p $STAGING_PORT $STAGING_USER@$STAGING_HOST "cat /home/cicd/.ssh/id_rsa.pub")
PRODUCTION_PUBLIC_KEY=$($SSH_CMD -p $PRODUCTION_PORT $PRODUCTION_USER@$PRODUCTION_HOST "cat /home/cicd/.ssh/id_rsa.pub")

echo -e "\n${CYAN}Keys:${NC}"
echo -e "HOST_PUBLIC_KEY: $([ -n "$HOST_PUBLIC_KEY" ] && echo -e "\033[0;32mfound\e[0m" || echo "not found")"
echo -e "STAGING_PUBLIC_KEY: $([ -n "$STAGING_PUBLIC_KEY" ] && echo -e "\033[0;32mfound\e[0m" || echo "not found")"
echo -e "PRODUCTION_PUBLIC_KEY: $([ -n "$PRODUCTION_PUBLIC_KEY" ] && echo -e "\033[0;32mfound\e[0m" || echo "not found")"

publish_key() {
  local key=$1
  local user=$2
  local host=$3
  local port=$4
  echo -e "${CYAN}\nPublishing key (to: $user@$host:$port)...${NC}"
  $SSH_CMD -p $port $user@$host "grep -qxF '$key' /home/cicd/.ssh/authorized_keys && echo 'Key already exists' || (echo '$key' >> /home/cicd/.ssh/authorized_keys && echo 'Key added')"
}

if [ -n "$STAGING_PUBLIC_KEY" ]; then
  publish_key "$STAGING_PUBLIC_KEY" "$PRODUCTION_USER" "$PRODUCTION_HOST" "$PRODUCTION_PORT"
fi

if [ -n "$PRODUCTION_PUBLIC_KEY" ]; then
  publish_key "$PRODUCTION_PUBLIC_KEY" "$STAGING_USER" "$STAGING_HOST" "$STAGING_PORT"
fi

echo -e "\n${CYAN}Staging/production public keys::${NC}"

if [ -n "$STAGING_PUBLIC_KEY" ]; then
  echo -e "$STAGING_PUBLIC_KEY\n"
fi

if [ -n "$PRODUCTION_PUBLIC_KEY" ]; then
    echo -e "$PRODUCTION_PUBLIC_KEY\n"
fi

echo -e "\n${YELLOW}Add these keys to your GIT repository access keys ($GIT_REPO):${NC}"

echo -e "\n${CYAN}Finished!${NC}"